<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encounter Henley Prayer Room Insights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #ffffff;
            color: #262730;
        }
        .sidebar {
            background-color: #f0f2f6;
            min-height: 100vh;
            padding: 2rem 1rem;
            border-right: 1px solid #d6d6d6;
        }
        .main-content {
            padding: 2rem;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }
        .btn-primary {
            background-color: #ff4b4b; /* Streamlit Red */
            border-color: #ff4b4b;
        }
        .btn-primary:hover {
            background-color: #ff2b2b;
            border-color: #ff2b2b;
        }
        .st-alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            color: white;
            background-color: #7A8AB2;
        }
        .metric-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 1rem;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #555;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .metric-delta {
            font-size: 0.8rem;
        }
        .metric-delta.positive { color: green; }
        .metric-delta.negative { color: red; }
        .metric-delta.off { color: gray; }

        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: 700;
            border-bottom: 2px solid #ff4b4b;
        }
        .img-fluid {
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .pill {
            background-color: #e6e6e6;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            display: inline-block;
            cursor: pointer;
        }
        .pill:hover {
            background-color: #d4d4d4;
        }
        .pill.selected {
            background-color: #ff4b4b;
            color: white;
        }
    </style>
</head>
<body>

<div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- SIDEBAR -->
        <div class="col-md-3 col-lg-2 sidebar">
            {% if logo_exists %}
            <div class="text-center mb-4">
                <img src="/static/images/logo.png" alt="Logo" style="max-width: 100px;">
            </div>
            {% else %}
            <div class="alert alert-warning">Logo not found</div>
            {% endif %}

            <h5 class="mt-4">Data Management</h5>
            <p class="small text-muted">current.csv last updated:<br><span id="lastUpdated">{{ last_updated }}</span></p>

            <div class="mb-3">
                <label class="form-label small">Upload new current.csv</label>
                <input type="file" class="form-control form-control-sm" id="fileUpload">
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" onclick="uploadFile()">Replace File</button>
            </div>

            <hr>

            <h5>Configuration</h5>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="includeGwop" checked>
                <label class="form-check-label" for="includeGwop">Include 'gwop.csv' data</label>
            </div>

            <h6 class="mt-3">Date Range Filter</h6>
            <div class="mb-2">
                <label class="small">Start Date</label>
                <input type="date" class="form-control form-control-sm" id="startDate" value="2025-01-05">
            </div>
            <div class="mb-3">
                <label class="small">End Date</label>
                <input type="date" class="form-control form-control-sm" id="endDate">
            </div>

            <h6 class="mt-3">Chart Goal Line</h6>
            <label class="small">Goal Percentage: <span id="goalVal">10</span>%</label>
            <input type="range" class="form-range" id="goalPercentage" min="0" max="100" step="5" value="10" oninput="document.getElementById('goalVal').innerText = this.value">

            <hr>
            <button class="btn btn-primary w-100" onclick="runAnalysis()">Run Analysis</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-md-9 col-lg-10 main-content">
            <h1>Encounter Henley Prayer Room Insights</h1>
            <p>Discovering prayer impact from the city to beach. Customise the analysis in the sidebar and press <strong>Run Analysis</strong>.</p>

            <hr>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">General Analytics</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="praydays-tab" data-bs-toggle="tab" data-bs-target="#praydays" type="button" role="tab">Pray Days Analytics</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab">Admin</button>
                </li>
            </ul>

            <div class="tab-content pt-3" id="myTabContent">

                <!-- GENERAL ANALYTICS TAB -->
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    <div id="general-placeholder" class="alert alert-info">
                        Set your analysis parameters in the sidebar and click <strong>Run Analysis</strong> to generate the dashboard.
                    </div>

                    <div id="general-results" style="display:none;">
                        <!-- Recent Activity -->
                        <div class="st-alert mb-4">
                            <h4 class="text-white">Recent Activity (Unfiltered Data)</h4>
                            <div class="row">
                                <div class="col-md-6 border-end border-light">
                                    <h5 class="text-white">Last 7 Days</h5>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="small text-white">Total Hours</div>
                                            <div class="h3 text-white" id="h7-val">0</div>
                                            <div class="small" id="c7-val"></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="small text-white">Unique Users</div>
                                            <div class="h3 text-white" id="u7-val">0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="text-white">Last 28 Days</h5>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="small text-white">Total Hours</div>
                                            <div class="h3 text-white" id="h28-val">0</div>
                                            <div class="small" id="c28-val"></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="small text-white">Unique Users</div>
                                            <div class="h3 text-white" id="u28-val">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Overview -->
                        <h3>Analysis Overview (Filtered Data)</h3>
                        <div class="row mb-4">
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Total Hours</div><div class="metric-value" id="total-hours"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Total Unique Users</div><div class="metric-value" id="total-users"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Avg Hours/Week</div><div class="metric-value" id="avg-hours-week"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Avg Hours/Month</div><div class="metric-value" id="avg-hours-month"></div></div></div>
                        </div>

                        <h4>Regulars and Occupancy</h4>
                        <div class="row mb-4">
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Weekly Regulars</div><div class="metric-value" id="weekly-regs"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Fortnightly Regulars</div><div class="metric-value" id="fortnightly-regs"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Hrs by Weekly Regs (%)</div><div class="metric-value" id="weekly-regs-pct"></div></div></div>
                            <div class="col-md-3"><div class="metric-card"><div class="metric-label">Total Sessions</div><div class="metric-value" id="total-sessions"></div></div></div>
                        </div>

                        <!-- Accordions for Regulars -->
                        <div class="accordion mb-4" id="regularsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWeekly">
                                        Weekly Regulars Details
                                    </button>
                                </h2>
                                <div id="collapseWeekly" class="accordion-collapse collapse" data-bs-parent="#regularsAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-sm table-striped" id="weekly-regs-table"></table>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFortnightly">
                                        Fortnightly Regulars Details
                                    </button>
                                </h2>
                                <div id="collapseFortnightly" class="accordion-collapse collapse" data-bs-parent="#regularsAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-sm table-striped" id="fortnightly-regs-table"></table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <h3>Time-Series & Distribution Charts</h3>
                        <div class="row">
                            <div class="col-md-6"><img id="plot-weekly-total" class="img-fluid w-100" src=""></div>
                            <div class="col-md-6"><img id="plot-monthly-total" class="img-fluid w-100" src=""></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6"><img id="plot-hourly-dist" class="img-fluid w-100" src=""></div>
                            <div class="col-md-6"><img id="plot-hourly-users" class="img-fluid w-100" src=""></div>
                        </div>
                        <div class="row">
                            <div class="col-12"><img id="plot-avg-dist" class="img-fluid w-100" src=""></div>
                        </div>

                        <hr>

                        <h3>Slot Details</h3>
                        <h4>Top Booking Timeslots</h4>
                        <div id="top-slots-container"></div>

                        <h4 class="mt-4">Weekly Slot Likelihood Comparison</h4>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered" id="slot-likelihood-table"></table>
                        </div>

                        <div class="mt-3">
                            <a id="download-user-summary" class="btn btn-secondary btn-sm" href="#" target="_blank">Download Full User Summary CSV</a>
                        </div>
                    </div>
                </div>

                <!-- PRAY DAYS TAB -->
                <div class="tab-pane fade" id="praydays" role="tabpanel">
                    <div id="praydays-placeholder" class="alert alert-info">Run analysis to see Pray Day insights.</div>

                    <div id="praydays-results" style="display:none;">
                        <h2>Pray Days Analysis</h2>
                        <div class="row mb-4">
                            <div class="col-md-4"><div class="metric-card"><div class="metric-label">Total Individual Participants</div><div class="metric-value" id="pd-total-participants"></div></div></div>
                            <div class="col-md-4"><div class="metric-card"><div class="metric-label">Total Repeaters</div><div class="metric-value" id="pd-total-repeaters"></div></div></div>
                            <div class="col-md-4"><div class="metric-card"><div class="metric-label">New to Pray Day (Latest)</div><div class="metric-value" id="pd-new-latest"></div></div></div>
                        </div>

                        <div class="accordion mb-4" id="newbiesAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNewbies">
                                        New to Pray Day Details
                                    </button>
                                </h2>
                                <div id="collapseNewbies" class="accordion-collapse collapse" data-bs-parent="#newbiesAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-sm" id="pd-newbies-table"></table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3>Per Pray Day Breakdown</h3>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped" id="pd-breakdown-table">
                                <!-- Transposed table will go here -->
                            </table>
                        </div>

                        <div class="mt-3">
                            <a id="download-pd-breakdown" class="btn btn-secondary btn-sm" href="#" target="_blank">Download Breakdown Details (Excel/CSV)</a>
                        </div>
                    </div>
                </div>

                <!-- ADMIN TAB -->
                <div class="tab-pane fade" id="admin" role="tabpanel">
                    <h2>Pray Day Configuration</h2>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="excludeGwopNew">
                        <label class="form-check-label" for="excludeGwopNew">Exclude GWOP from 'New to Pray Day' Logic</label>
                    </div>

                    <div class="row g-2 align-items-end mb-3">
                        <div class="col-md-4">
                            <label class="small">Date</label>
                            <input type="date" class="form-control" id="newPdDate">
                        </div>
                        <div class="col-md-4">
                            <label class="small">Label</label>
                            <input type="text" class="form-control" id="newPdLabel" placeholder="Optional">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" onclick="addPrayDay()">Add Pray Day</button>
                        </div>
                    </div>

                    <h6>Configured Days:</h6>
                    <div id="pray-days-list" class="mb-4">
                        <!-- Pills go here -->
                    </div>

                    <hr>

                    <h2>Data Management</h2>
                    <div class="alert alert-info">To persist changes to GitHub, ensure GITHUB_TOKEN is set in environment.</div>

                    <div class="row">
                        <div class="col-md-6">
                            <h4>Email Duplicates</h4>
                            <div class="card p-3 mb-3">
                                <div class="mb-2">
                                    <input type="text" class="form-control mb-2" id="dupPrimary" placeholder="Primary Email">
                                    <input type="text" class="form-control mb-2" id="dupAdditional" placeholder="Additional Email">
                                    <button class="btn btn-sm btn-primary w-100" onclick="addDuplicate()">Add Mapping</button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#viewDupes">View Current</button>
                                <div class="collapse mt-2" id="viewDupes">
                                    <table class="table table-sm table-bordered" id="dupes-table" style="font-size:0.8rem"></table>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h4>Person Merges</h4>
                            <div class="card p-3 mb-3">
                                <div class="mb-2">
                                    <input type="text" class="form-control mb-2" id="mergeSource" placeholder="Source Key">
                                    <input type="text" class="form-control mb-2" id="mergeTarget" placeholder="Target Key">
                                    <button class="btn btn-sm btn-primary w-100" onclick="addMerge()">Add Merge</button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#viewMerges">View Current</button>
                                <div class="collapse mt-2" id="viewMerges">
                                    <table class="table table-sm table-bordered" id="merges-table" style="font-size:0.8rem"></table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- UTILS ---
    function showSpinner() { document.getElementById('loadingSpinner').style.display = 'flex'; }
    function hideSpinner() { document.getElementById('loadingSpinner').style.display = 'none'; }

    // --- LOAD INITIAL DATA ---
    document.addEventListener('DOMContentLoaded', () => {
        loadPrayDays();
        loadDuplicates();
        loadMerges();
    });

    // --- ANALYTICS ---
    async function runAnalysis() {
        showSpinner();

        const payload = {
            include_gwop: document.getElementById('includeGwop').checked,
            exclude_gwop_new: document.getElementById('excludeGwopNew').checked,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            goal_percentage: parseInt(document.getElementById('goalPercentage').value)
        };

        try {
            const res = await fetch('/api/run_analysis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if(data.success) {
                displayResults(data);
            } else {
                alert('Analysis failed: ' + data.message);
            }
        } catch(e) {
            alert('Error running analysis: ' + e);
        } finally {
            hideSpinner();
        }
    }

    function displayResults(data) {
        // Show sections
        document.getElementById('general-placeholder').style.display = 'none';
        document.getElementById('general-results').style.display = 'block';
        document.getElementById('praydays-placeholder').style.display = 'none';
        document.getElementById('praydays-results').style.display = 'block';

        // 1. RECENT STATS
        const r = data.recent_stats;
        document.getElementById('h7-val').innerText = r.H7;
        document.getElementById('u7-val').innerText = r.U7;
        formatDelta('c7-val', r.C7);

        document.getElementById('h28-val').innerText = r.H28;
        document.getElementById('u28-val').innerText = r.U28;
        formatDelta('c28-val', r.C28);

        // 2. METRICS
        const m = data.metrics;
        document.getElementById('total-hours').innerText = m['Total Hours of Prayer'] || '-';
        document.getElementById('total-users').innerText = m['Total Individual Users'] || '-';
        document.getElementById('avg-hours-week').innerText = m['Avg Hours per Week (Filtered Period)'] || '-';
        document.getElementById('avg-hours-month').innerText = m['Avg Hours per Month (Filtered Period)'] || '-';

        document.getElementById('weekly-regs').innerText = m['Number of Weekly Regulars'] || '-';
        document.getElementById('fortnightly-regs').innerText = m['Number of Fortnightly Regulars'] || '-';
        document.getElementById('weekly-regs-pct').innerText = m['Total Hours by Weekly Regulars (%)'] || '-';
        document.getElementById('total-sessions').innerText = data.total_sessions;

        // 3. REGULARS TABLES
        renderTable('weekly-regs-table', data.weekly_regulars, ['Name', 'Avg Hours/Week'], ['person_name', 'weekly_avg_hours']);
        renderTable('fortnightly-regs-table', data.fortnightly_regulars, ['Name', 'Avg Hours/Week'], ['person_name', 'weekly_avg_hours']);

        // 4. PLOTS
        const ts = new Date().getTime(); // cache bust
        const outDir = data.output_dir.replace('static/', '');
        document.getElementById('plot-weekly-total').src = `/static/${outDir}/weekly_total_hours.png?t=${ts}`;
        document.getElementById('plot-monthly-total').src = `/static/${outDir}/monthly_total_hours.png?t=${ts}`;
        document.getElementById('plot-hourly-dist').src = `/static/${outDir}/hourly_distribution.png?t=${ts}`;
        document.getElementById('plot-hourly-users').src = `/static/${outDir}/hourly_users.png?t=${ts}`;
        document.getElementById('plot-avg-dist').src = `/static/${outDir}/avg_hours_distribution.png?t=${ts}`;

        // 5. TOP SLOTS
        const slotsContainer = document.getElementById('top-slots-container');
        slotsContainer.innerHTML = '';
        let slotIdx = 1;
        for (const [key, val] of Object.entries(m)) {
            if (key.includes('Top') && !key.includes('%')) {
                // Parse val: "Monday at 06:00 with 10 bookings"
                const cleanVal = val.split(' with ')[0].replace('bookings', '').trim();
                const bookings = val.split(' with ')[1] || '';

                const div = document.createElement('div');
                div.className = 'alert ' + (slotIdx === 1 ? 'alert-warning' : 'alert-secondary');
                div.innerHTML = `<strong>#${slotIdx}</strong> ${cleanVal} <strong>- ${bookings}</strong>`;
                slotsContainer.appendChild(div);
                slotIdx++;
            }
        }

        // 6. LIKELIHOOD TABLE
        renderTable('slot-likelihood-table', data.slot_likelihood, ['Metric', 'Weekday', 'Hour', 'Likelihood'], ['Metric', 'weekday', 'Hour (24hr)', 'Likelihood Value']);

        // 7. DOWNLOAD LINK
        document.getElementById('download-user-summary').href = `/api/download/${outDir.split('/').pop()}/user.csv`;

        // --- PRAY DAYS ---
        const pd = data.pray_days;
        document.getElementById('pd-total-participants').innerText = pd.total_participants;
        document.getElementById('pd-total-repeaters').innerText = pd.total_repeaters;

        // Find latest newbies
        let latestNewbies = 0;
        let latestDate = null;
        if (pd.summary.length > 0) {
            // Sort by Date
            const sorted = pd.summary.sort((a,b) => new Date(a.Date) - new Date(b.Date));
            const last = sorted[sorted.length - 1];
            latestNewbies = last['Total New Users'];
            latestDate = last['Date'];

            // Render breakdown details for latest
            if (pd.newbies_details && pd.newbies_details[latestDate]) {
                renderTable('pd-newbies-table', pd.newbies_details[latestDate], ['Name', 'Total Hours'], ['Name', 'Total Hours']);
            }
        }
        document.getElementById('pd-new-latest').innerText = latestNewbies;

        // Transpose Summary Table
        renderTransposedTable('pd-breakdown-table', pd.summary);

        document.getElementById('download-pd-breakdown').href = `/api/download/${outDir.split('/').pop()}/pray_day_breakdown.csv`;
    }

    // --- HELPERS ---
    function formatDelta(id, val) {
        const el = document.getElementById(id);
        if (val == 0) {
            el.innerHTML = '<span class="metric-delta off">No Change</span>';
        } else {
            const color = val > 0 ? 'positive' : 'negative';
            el.innerHTML = `<span class="metric-delta ${color}">${val.toFixed(1)}%</span>`;
        }
    }

    function renderTable(id, data, headers, keys) {
        const table = document.getElementById(id);
        table.innerHTML = '';
        if(!data || data.length === 0) return;

        const thead = table.createTHead();
        const row = thead.insertRow();
        headers.forEach(h => {
            const th = document.createElement('th');
            th.innerText = h;
            row.appendChild(th);
        });

        const tbody = table.createTBody();
        data.forEach(item => {
            const tr = tbody.insertRow();
            keys.forEach(k => {
                const td = tr.insertCell();
                td.innerText = item[k] !== undefined ? item[k] : '';
            });
        });
    }

    function renderTransposedTable(id, data) {
        const table = document.getElementById(id);
        table.innerHTML = '';
        if (!data || data.length === 0) return;

        // Sort data by date
        data.sort((a,b) => new Date(a.Date) - new Date(b.Date));

        // Get all metrics (keys except Date)
        const metrics = Object.keys(data[0]).filter(k => k !== 'Date');

        // Header Row (Metrics column + Dates)
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        const thFirst = document.createElement('th');
        thFirst.innerText = 'Metric';
        headerRow.appendChild(thFirst);

        data.forEach(d => {
            const th = document.createElement('th');
            // Format date nicely: 24th May 25
            const dateObj = new Date(d.Date);
            const day = dateObj.getDate();
            const suffix = (day >= 11 && day <= 13) ? 'th' : {1:'st',2:'nd',3:'rd'}[day%10] || 'th';
            const month = dateObj.toLocaleString('default', { month: 'short' });
            const year = dateObj.getFullYear().toString().substr(-2);
            th.innerText = `${day}${suffix} ${month} ${year}`;
            headerRow.appendChild(th);
        });

        const tbody = table.createTBody();
        metrics.forEach(metric => {
            const tr = tbody.insertRow();
            const tdMetric = tr.insertCell();
            tdMetric.innerText = metric;
            tdMetric.style.fontWeight = 'bold';

            data.forEach(d => {
                const td = tr.insertCell();
                td.innerText = d[metric];
            });
        });
    }

    // --- CONFIG & ADMIN ---
    async function uploadFile() {
        const input = document.getElementById('fileUpload');
        if(!input.files[0]) return;

        const formData = new FormData();
        formData.append('file', input.files[0]);

        showSpinner();
        try {
            const res = await fetch('/api/upload_current', {method:'POST', body:formData});
            const data = await res.json();
            alert(data.message);
            location.reload();
        } catch(e) { alert(e); } finally { hideSpinner(); }
    }

    async function loadPrayDays() {
        const res = await fetch('/api/config/pray_days');
        const data = await res.json();
        const container = document.getElementById('pray-days-list');
        container.innerHTML = '';

        // Sort
        data.sort((a,b) => new Date(a.date) - new Date(b.date));

        data.forEach(d => {
            const dateObj = new Date(d.date);
            const displayDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            const label = d.label ? ` - ${d.label}` : '';

            const pill = document.createElement('span');
            pill.className = 'pill selected';
            pill.innerHTML = `${displayDate}${label} &times;`;
            pill.onclick = () => removePrayDay(d.date);
            container.appendChild(pill);
        });
    }

    async function addPrayDay() {
        const date = document.getElementById('newPdDate').value;
        const label = document.getElementById('newPdLabel').value;
        if(!date) return;

        await fetch('/api/config/pray_days', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date, label})
        });
        loadPrayDays();
    }

    async function removePrayDay(date) {
        if(!confirm('Remove this Pray Day?')) return;
        await fetch('/api/config/pray_days', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({date})
        });
        loadPrayDays();
    }

    async function loadDuplicates() {
        const res = await fetch('/api/config/duplicates');
        const data = await res.json();
        renderTable('dupes-table', data, ['Primary', 'Additional'], ['primary', 'additional']);
    }

    async function addDuplicate() {
        const primary = document.getElementById('dupPrimary').value;
        const additional = document.getElementById('dupAdditional').value;
        if(!primary || !additional) return;

        const res = await fetch('/api/config/duplicates', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({primary, additional})
        });
        const data = await res.json();
        if(data.success) {
            alert('Added mapping');
            loadDuplicates();
            // Trigger Git sync
            syncGit("email_duplicates.csv", `Update email_duplicates.csv: Add ${additional}`);
        }
    }

    async function loadMerges() {
        const res = await fetch('/api/config/merges');
        const data = await res.json();
        renderTable('merges-table', data, ['Source', 'Target'], ['source_key', 'target_key']);
    }

    async function addMerge() {
        const source_key = document.getElementById('mergeSource').value;
        const target_key = document.getElementById('mergeTarget').value;
        if(!source_key || !target_key) return;

        const res = await fetch('/api/config/merges', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({source_key, target_key})
        });
        const data = await res.json();
        if(data.success) {
            alert('Added merge');
            loadMerges();
             // Trigger Git sync
            syncGit("person_merges.csv", `Update person_merges.csv: Merge ${source_key} -> ${target_key}`);
        }
    }

    async function syncGit(filename, message) {
        // Optimistic UI, don't block
        fetch('/api/git_sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename, message})
        }).then(r => r.json()).then(d => {
            if(!d.success) console.warn('Git sync failed:', d.message);
            else console.log('Git sync success');
        });
    }

</script>
</body>
</html>
