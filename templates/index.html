{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">General Analytics</h1>
    <span class="badge bg-secondary">
        Range: {{ settings.start_date }} to {{ settings.end_date if settings.end_date else "Today" }}
    </span>
</div>

<!-- Recent Activity -->
<h4 class="mb-3">Recent Activity (Unfiltered)</h4>
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Hours (7 Days)</div>
            <div class="metric-value">{{ recent.H7 }}
                {% if recent.C7 != 0 %}
                <small class="text-{{ 'success' if recent.C7 > 0 else 'danger' }}" style="font-size: 0.7em;">
                    {{ "%+.1f"|format(recent.C7) }}%
                </small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Users (7 Days)</div>
            <div class="metric-value">{{ recent.U7 }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Hours (28 Days)</div>
            <div class="metric-value">{{ recent.H28 }}
                 {% if recent.C28 != 0 %}
                <small class="text-{{ 'success' if recent.C28 > 0 else 'danger' }}" style="font-size: 0.7em;">
                    {{ "%+.1f"|format(recent.C28) }}%
                </small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Users (28 Days)</div>
            <div class="metric-value">{{ recent.U28 }}</div>
        </div>
    </div>
</div>

<hr>

<!-- Analysis Overview -->
<h4 class="mb-3">Analysis Overview (Filtered)</h4>
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Total Hours</div>
            <div class="metric-value">{{ data.total_hours }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Unique Users</div>
            <div class="metric-value">{{ data.total_users }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Avg Hours/Week</div>
            <div class="metric-value">{{ data.avg_hours_week }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Avg Hours/Month</div>
            <div class="metric-value">{{ metrics['Avg Hours per Month (Filtered Period)'] }}</div>
        </div>
    </div>
</div>

<h5 class="mb-3 text-muted">Regulars and Occupancy</h5>
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Weekly Regulars</div>
            <div class="metric-value">{{ data.weekly_regulars }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Fortnightly Regulars</div>
            <div class="metric-value">{{ data.fortnightly_regulars }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Hours by Weekly Regs (%)</div>
            <div class="metric-value">{{ metrics['Total Hours by Weekly Regulars (%)'] }}</div>
        </div>
    </div>
    <div class="col-6 col-md-3 metric-col">
        <div class="metric-card">
            <div class="metric-label">Total Sessions</div>
            <div class="metric-value">{{ data.total_sessions }}</div>
        </div>
    </div>
</div>

<!-- Details Accordion -->
<div class="accordion mb-4" id="regularsAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWeekly">
        Weekly Regulars Details
      </button>
    </h2>
    <div id="collapseWeekly" class="accordion-collapse collapse" data-bs-parent="#regularsAccordion">
      <div class="accordion-body">
        <table class="table table-sm table-striped">
            <thead><tr><th>Name</th><th>Avg Hours/Week</th></tr></thead>
            <tbody>
                {% for row in weekly_regulars %}
                <tr><td>{{ row.person_name }}</td><td>{{ row.weekly_avg_hours }}</td></tr>
                {% else %}
                <tr><td colspan="2">No weekly regulars found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="accordion-item">
    <h2 class="accordion-header">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFortnightly">
        Fortnightly Regulars Details
      </button>
    </h2>
    <div id="collapseFortnightly" class="accordion-collapse collapse" data-bs-parent="#regularsAccordion">
      <div class="accordion-body">
         <table class="table table-sm table-striped">
            <thead><tr><th>Name</th><th>Avg Hours/Week</th></tr></thead>
            <tbody>
                {% for row in fortnightly_regulars %}
                <tr><td>{{ row.person_name }}</td><td>{{ row.weekly_avg_hours }}</td></tr>
                {% else %}
                <tr><td colspan="2">No fortnightly regulars found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<hr>

<!-- Charts -->
<h4 class="mb-3">Charts</h4>
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <img src="{{ url_for('static', filename='plots/weekly_total_hours.png') }}" class="img-fluid rounded shadow-sm" alt="Weekly Total Hours">
    </div>
    <div class="col-md-6">
        <img src="{{ url_for('static', filename='plots/monthly_total_hours.png') }}" class="img-fluid rounded shadow-sm" alt="Monthly Total Hours">
    </div>
    <div class="col-md-6">
        <img src="{{ url_for('static', filename='plots/hourly_distribution.png') }}" class="img-fluid rounded shadow-sm" alt="Hourly Dist">
    </div>
    <div class="col-md-6">
        <img src="{{ url_for('static', filename='plots/hourly_users.png') }}" class="img-fluid rounded shadow-sm" alt="Hourly Users">
    </div>
     <div class="col-12">
        <img src="{{ url_for('static', filename='plots/avg_hours_distribution.png') }}" class="img-fluid rounded shadow-sm" alt="User Distribution">
    </div>
</div>

<hr>

<!-- Slot Details -->
<h4 class="mb-3">Slot Details</h4>
<div class="mb-4">
    <h5>Top Booking Timeslots</h5>
    {% for slot in top_slots %}
    <div class="alert alert-warning d-flex align-items-center" role="alert">
         <span class="me-2 fs-4">{% if slot.rank == 1 %}üèÜ{% else %}‚≠ê{% endif %}</span>
         <div>
             <strong>#{{ slot.rank }} - {{ slot.value }}</strong>
         </div>
    </div>
    {% endfor %}
</div>

<div class="mb-4">
    <h5>Weekly Slot Likelihood Comparison</h5>
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Weekday</th>
                    <th>Hour (24hr)</th>
                    <th>Likelihood Value</th>
                </tr>
            </thead>
            <tbody>
                {% for row in likelihood %}
                <tr>
                    <td>{{ row.Metric }}</td>
                    <td>{{ row.weekday }}</td>
                    <td>{{ row.hour }}</td>
                    <td>{{ row['Likelihood Value'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}
